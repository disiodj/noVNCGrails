{"version":3,"sources":["cursor.js"],"names":["useFallback","supportsCursorURIs","isTouchDevice","Cursor","_target","_canvas","document","createElement","style","position","zIndex","pointerEvents","visibility","_position","x","y","_hotSpot","_eventHandlers","_handleMouseOver","bind","_handleMouseLeave","_handleMouseMove","_handleMouseUp","target","detach","body","appendChild","options","capture","passive","addEventListener","mouseover","mouseleave","mousemove","mouseup","clear","removeEventListener","removeChild","rgba","hotx","hoty","w","h","ctx","getContext","width","height","img","ImageData","Uint8ClampedArray","clearRect","putImageData","_updatePosition","url","toDataURL","cursor","clientX","clientY","window","visualViewport","offsetLeft","offsetTop","elementFromPoint","_updateVisibility","event","relatedTarget","_captureIsActive","setTimeout","contains","getComputedStyle","captureElement","_shouldShowCursor","_showCursor","_hideCursor","left","top","documentElement"],"mappings":";;;;;;;AAMA;;;;;;;;AAEA,IAAMA,WAAW,GAAG,CAACC,2BAAD,IAAuBC,sBAA3C;;IAEqBC,M;AACjB,oBAAc;AAAA;;AACV,SAAKC,OAAL,GAAe,IAAf;AAEA,SAAKC,OAAL,GAAeC,QAAQ,CAACC,aAAT,CAAuB,QAAvB,CAAf;;AAEA,QAAIP,WAAJ,EAAiB;AACb,WAAKK,OAAL,CAAaG,KAAb,CAAmBC,QAAnB,GAA8B,OAA9B;AACA,WAAKJ,OAAL,CAAaG,KAAb,CAAmBE,MAAnB,GAA4B,OAA5B;AACA,WAAKL,OAAL,CAAaG,KAAb,CAAmBG,aAAnB,GAAmC,MAAnC,CAHa,CAIb;;AACA,WAAKN,OAAL,CAAaG,KAAb,CAAmBI,UAAnB,GAAgC,QAAhC;AACH;;AAED,SAAKC,SAAL,GAAiB;AAAEC,MAAAA,CAAC,EAAE,CAAL;AAAQC,MAAAA,CAAC,EAAE;AAAX,KAAjB;AACA,SAAKC,QAAL,GAAgB;AAAEF,MAAAA,CAAC,EAAE,CAAL;AAAQC,MAAAA,CAAC,EAAE;AAAX,KAAhB;AAEA,SAAKE,cAAL,GAAsB;AAClB,mBAAa,KAAKC,gBAAL,CAAsBC,IAAtB,CAA2B,IAA3B,CADK;AAElB,oBAAc,KAAKC,iBAAL,CAAuBD,IAAvB,CAA4B,IAA5B,CAFI;AAGlB,mBAAa,KAAKE,gBAAL,CAAsBF,IAAtB,CAA2B,IAA3B,CAHK;AAIlB,iBAAW,KAAKG,cAAL,CAAoBH,IAApB,CAAyB,IAAzB;AAJO,KAAtB;AAMH;;;;2BAEMI,M,EAAQ;AACX,UAAI,KAAKnB,OAAT,EAAkB;AACd,aAAKoB,MAAL;AACH;;AAED,WAAKpB,OAAL,GAAemB,MAAf;;AAEA,UAAIvB,WAAJ,EAAiB;AACbM,QAAAA,QAAQ,CAACmB,IAAT,CAAcC,WAAd,CAA0B,KAAKrB,OAA/B;AAEA,YAAMsB,OAAO,GAAG;AAAEC,UAAAA,OAAO,EAAE,IAAX;AAAiBC,UAAAA,OAAO,EAAE;AAA1B,SAAhB;;AACA,aAAKzB,OAAL,CAAa0B,gBAAb,CAA8B,WAA9B,EAA2C,KAAKb,cAAL,CAAoBc,SAA/D,EAA0EJ,OAA1E;;AACA,aAAKvB,OAAL,CAAa0B,gBAAb,CAA8B,YAA9B,EAA4C,KAAKb,cAAL,CAAoBe,UAAhE,EAA4EL,OAA5E;;AACA,aAAKvB,OAAL,CAAa0B,gBAAb,CAA8B,WAA9B,EAA2C,KAAKb,cAAL,CAAoBgB,SAA/D,EAA0EN,OAA1E;;AACA,aAAKvB,OAAL,CAAa0B,gBAAb,CAA8B,SAA9B,EAAyC,KAAKb,cAAL,CAAoBiB,OAA7D,EAAsEP,OAAtE;AACH;;AAED,WAAKQ,KAAL;AACH;;;6BAEQ;AACL,UAAI,CAAC,KAAK/B,OAAV,EAAmB;AACf;AACH;;AAED,UAAIJ,WAAJ,EAAiB;AACb,YAAM2B,OAAO,GAAG;AAAEC,UAAAA,OAAO,EAAE,IAAX;AAAiBC,UAAAA,OAAO,EAAE;AAA1B,SAAhB;;AACA,aAAKzB,OAAL,CAAagC,mBAAb,CAAiC,WAAjC,EAA8C,KAAKnB,cAAL,CAAoBc,SAAlE,EAA6EJ,OAA7E;;AACA,aAAKvB,OAAL,CAAagC,mBAAb,CAAiC,YAAjC,EAA+C,KAAKnB,cAAL,CAAoBe,UAAnE,EAA+EL,OAA/E;;AACA,aAAKvB,OAAL,CAAagC,mBAAb,CAAiC,WAAjC,EAA8C,KAAKnB,cAAL,CAAoBgB,SAAlE,EAA6EN,OAA7E;;AACA,aAAKvB,OAAL,CAAagC,mBAAb,CAAiC,SAAjC,EAA4C,KAAKnB,cAAL,CAAoBiB,OAAhE,EAAyEP,OAAzE;;AAEArB,QAAAA,QAAQ,CAACmB,IAAT,CAAcY,WAAd,CAA0B,KAAKhC,OAA/B;AACH;;AAED,WAAKD,OAAL,GAAe,IAAf;AACH;;;2BAEMkC,I,EAAMC,I,EAAMC,I,EAAMC,C,EAAGC,C,EAAG;AAC3B,UAAKD,CAAC,KAAK,CAAP,IAAcC,CAAC,KAAK,CAAxB,EAA4B;AACxB,aAAKP,KAAL;AACA;AACH;;AAED,WAAKtB,SAAL,CAAeC,CAAf,GAAmB,KAAKD,SAAL,CAAeC,CAAf,GAAmB,KAAKE,QAAL,CAAcF,CAAjC,GAAqCyB,IAAxD;AACA,WAAK1B,SAAL,CAAeE,CAAf,GAAmB,KAAKF,SAAL,CAAeE,CAAf,GAAmB,KAAKC,QAAL,CAAcD,CAAjC,GAAqCyB,IAAxD;AACA,WAAKxB,QAAL,CAAcF,CAAd,GAAkByB,IAAlB;AACA,WAAKvB,QAAL,CAAcD,CAAd,GAAkByB,IAAlB;;AAEA,UAAIG,GAAG,GAAG,KAAKtC,OAAL,CAAauC,UAAb,CAAwB,IAAxB,CAAV;;AAEA,WAAKvC,OAAL,CAAawC,KAAb,GAAqBJ,CAArB;AACA,WAAKpC,OAAL,CAAayC,MAAb,GAAsBJ,CAAtB;AAEA,UAAIK,GAAG,GAAG,IAAIC,SAAJ,CAAc,IAAIC,iBAAJ,CAAsBX,IAAtB,CAAd,EAA2CG,CAA3C,EAA8CC,CAA9C,CAAV;AACAC,MAAAA,GAAG,CAACO,SAAJ,CAAc,CAAd,EAAiB,CAAjB,EAAoBT,CAApB,EAAuBC,CAAvB;AACAC,MAAAA,GAAG,CAACQ,YAAJ,CAAiBJ,GAAjB,EAAsB,CAAtB,EAAyB,CAAzB;;AAEA,UAAI/C,WAAJ,EAAiB;AACb,aAAKoD,eAAL;AACH,OAFD,MAEO;AACH,YAAIC,GAAG,GAAG,KAAKhD,OAAL,CAAaiD,SAAb,EAAV;;AACA,aAAKlD,OAAL,CAAaI,KAAb,CAAmB+C,MAAnB,GAA4B,SAASF,GAAT,GAAe,GAAf,GAAqBd,IAArB,GAA4B,GAA5B,GAAkCC,IAAlC,GAAyC,WAArE;AACH;AACJ;;;4BAEO;AACJ,WAAKpC,OAAL,CAAaI,KAAb,CAAmB+C,MAAnB,GAA4B,MAA5B;AACA,WAAKlD,OAAL,CAAawC,KAAb,GAAqB,CAArB;AACA,WAAKxC,OAAL,CAAayC,MAAb,GAAsB,CAAtB;AACA,WAAKjC,SAAL,CAAeC,CAAf,GAAmB,KAAKD,SAAL,CAAeC,CAAf,GAAmB,KAAKE,QAAL,CAAcF,CAApD;AACA,WAAKD,SAAL,CAAeE,CAAf,GAAmB,KAAKF,SAAL,CAAeE,CAAf,GAAmB,KAAKC,QAAL,CAAcD,CAApD;AACA,WAAKC,QAAL,CAAcF,CAAd,GAAkB,CAAlB;AACA,WAAKE,QAAL,CAAcD,CAAd,GAAkB,CAAlB;AACH,K,CAED;AACA;;;;yBACKyC,O,EAASC,O,EAAS;AACnB,UAAI,CAACzD,WAAL,EAAkB;AACd;AACH,OAHkB,CAInB;AACA;AACA;;;AACA,UAAI0D,MAAM,CAACC,cAAX,EAA2B;AACvB,aAAK9C,SAAL,CAAeC,CAAf,GAAmB0C,OAAO,GAAGE,MAAM,CAACC,cAAP,CAAsBC,UAAnD;AACA,aAAK/C,SAAL,CAAeE,CAAf,GAAmB0C,OAAO,GAAGC,MAAM,CAACC,cAAP,CAAsBE,SAAnD;AACH,OAHD,MAGO;AACH,aAAKhD,SAAL,CAAeC,CAAf,GAAmB0C,OAAnB;AACA,aAAK3C,SAAL,CAAeE,CAAf,GAAmB0C,OAAnB;AACH;;AACD,WAAKL,eAAL;;AACA,UAAI7B,MAAM,GAAGjB,QAAQ,CAACwD,gBAAT,CAA0BN,OAA1B,EAAmCC,OAAnC,CAAb;;AACA,WAAKM,iBAAL,CAAuBxC,MAAvB;AACH;;;qCAEgByC,K,EAAO;AACpB;AACA;AACA;AACA,WAAK3C,gBAAL,CAAsB2C,KAAtB;AACH;;;sCAEiBA,K,EAAO;AACrB;AACA,WAAKD,iBAAL,CAAuBC,KAAK,CAACC,aAA7B;AACH;;;qCAEgBD,K,EAAO;AACpB,WAAKD,iBAAL,CAAuBC,KAAK,CAACzC,MAA7B;;AAEA,WAAKV,SAAL,CAAeC,CAAf,GAAmBkD,KAAK,CAACR,OAAN,GAAgB,KAAKxC,QAAL,CAAcF,CAAjD;AACA,WAAKD,SAAL,CAAeE,CAAf,GAAmBiD,KAAK,CAACP,OAAN,GAAgB,KAAKzC,QAAL,CAAcD,CAAjD;;AAEA,WAAKqC,eAAL;AACH;;;mCAEcY,K,EAAO;AAAA;;AAClB;AACA;AACA;AACA,UAAIzC,MAAM,GAAGjB,QAAQ,CAACwD,gBAAT,CAA0BE,KAAK,CAACR,OAAhC,EAAyCQ,KAAK,CAACP,OAA/C,CAAb;;AACA,WAAKM,iBAAL,CAAuBxC,MAAvB,EALkB,CAOlB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACA,UAAI,KAAK2C,gBAAL,EAAJ,EAA6B;AACzBR,QAAAA,MAAM,CAACS,UAAP,CAAkB,YAAM;AACpB;AACA,cAAI,CAAC,KAAI,CAAC/D,OAAV,EAAmB;AACf;AACH,WAJmB,CAKpB;AACA;;;AACAmB,UAAAA,MAAM,GAAGjB,QAAQ,CAACwD,gBAAT,CAA0BE,KAAK,CAACR,OAAhC,EAC0BQ,KAAK,CAACP,OADhC,CAAT;;AAEA,UAAA,KAAI,CAACM,iBAAL,CAAuBxC,MAAvB;AACH,SAVD,EAUG,CAVH;AAWH;AACJ;;;kCAEa;AACV,UAAI,KAAKlB,OAAL,CAAaG,KAAb,CAAmBI,UAAnB,KAAkC,QAAtC,EAAgD;AAC5C,aAAKP,OAAL,CAAaG,KAAb,CAAmBI,UAAnB,GAAgC,EAAhC;AACH;AACJ;;;kCAEa;AACV,UAAI,KAAKP,OAAL,CAAaG,KAAb,CAAmBI,UAAnB,KAAkC,QAAtC,EAAgD;AAC5C,aAAKP,OAAL,CAAaG,KAAb,CAAmBI,UAAnB,GAAgC,QAAhC;AACH;AACJ,K,CAED;AACA;AACA;;;;sCACkBW,M,EAAQ;AACtB,UAAI,CAACA,MAAL,EAAa;AACT,eAAO,KAAP;AACH,OAHqB,CAItB;;;AACA,UAAIA,MAAM,KAAK,KAAKnB,OAApB,EAA6B;AACzB,eAAO,IAAP;AACH,OAPqB,CAQtB;;;AACA,UAAI,CAAC,KAAKA,OAAL,CAAagE,QAAb,CAAsB7C,MAAtB,CAAL,EAAoC;AAChC,eAAO,KAAP;AACH,OAXqB,CAYtB;AACA;AACA;;;AACA,UAAImC,MAAM,CAACW,gBAAP,CAAwB9C,MAAxB,EAAgCgC,MAAhC,KAA2C,MAA/C,EAAuD;AACnD,eAAO,KAAP;AACH;;AACD,aAAO,IAAP;AACH;;;sCAEiBhC,M,EAAQ;AACtB;AACA;AACA,UAAI,KAAK2C,gBAAL,EAAJ,EAA6B;AACzB3C,QAAAA,MAAM,GAAGjB,QAAQ,CAACgE,cAAlB;AACH;;AACD,UAAI,KAAKC,iBAAL,CAAuBhD,MAAvB,CAAJ,EAAoC;AAChC,aAAKiD,WAAL;AACH,OAFD,MAEO;AACH,aAAKC,WAAL;AACH;AACJ;;;sCAEiB;AACd,WAAKpE,OAAL,CAAaG,KAAb,CAAmBkE,IAAnB,GAA0B,KAAK7D,SAAL,CAAeC,CAAf,GAAmB,IAA7C;AACA,WAAKT,OAAL,CAAaG,KAAb,CAAmBmE,GAAnB,GAAyB,KAAK9D,SAAL,CAAeE,CAAf,GAAmB,IAA5C;AACH;;;uCAEkB;AACf,aAAOT,QAAQ,CAACgE,cAAT,IACHhE,QAAQ,CAACsE,eAAT,CAAyBR,QAAzB,CAAkC9D,QAAQ,CAACgE,cAA3C,CADJ;AAEH","sourcesContent":["/*\r\n * noVNC: HTML5 VNC client\r\n * Copyright (C) 2019 The noVNC Authors\r\n * Licensed under MPL 2.0 or any later version (see LICENSE.txt)\r\n */\r\n\r\nimport { supportsCursorURIs, isTouchDevice } from './browser.js';\r\n\r\nconst useFallback = !supportsCursorURIs || isTouchDevice;\r\n\r\nexport default class Cursor {\r\n    constructor() {\r\n        this._target = null;\r\n\r\n        this._canvas = document.createElement('canvas');\r\n\r\n        if (useFallback) {\r\n            this._canvas.style.position = 'fixed';\r\n            this._canvas.style.zIndex = '65535';\r\n            this._canvas.style.pointerEvents = 'none';\r\n            // Can't use \"display\" because of Firefox bug #1445997\r\n            this._canvas.style.visibility = 'hidden';\r\n        }\r\n\r\n        this._position = { x: 0, y: 0 };\r\n        this._hotSpot = { x: 0, y: 0 };\r\n\r\n        this._eventHandlers = {\r\n            'mouseover': this._handleMouseOver.bind(this),\r\n            'mouseleave': this._handleMouseLeave.bind(this),\r\n            'mousemove': this._handleMouseMove.bind(this),\r\n            'mouseup': this._handleMouseUp.bind(this),\r\n        };\r\n    }\r\n\r\n    attach(target) {\r\n        if (this._target) {\r\n            this.detach();\r\n        }\r\n\r\n        this._target = target;\r\n\r\n        if (useFallback) {\r\n            document.body.appendChild(this._canvas);\r\n\r\n            const options = { capture: true, passive: true };\r\n            this._target.addEventListener('mouseover', this._eventHandlers.mouseover, options);\r\n            this._target.addEventListener('mouseleave', this._eventHandlers.mouseleave, options);\r\n            this._target.addEventListener('mousemove', this._eventHandlers.mousemove, options);\r\n            this._target.addEventListener('mouseup', this._eventHandlers.mouseup, options);\r\n        }\r\n\r\n        this.clear();\r\n    }\r\n\r\n    detach() {\r\n        if (!this._target) {\r\n            return;\r\n        }\r\n\r\n        if (useFallback) {\r\n            const options = { capture: true, passive: true };\r\n            this._target.removeEventListener('mouseover', this._eventHandlers.mouseover, options);\r\n            this._target.removeEventListener('mouseleave', this._eventHandlers.mouseleave, options);\r\n            this._target.removeEventListener('mousemove', this._eventHandlers.mousemove, options);\r\n            this._target.removeEventListener('mouseup', this._eventHandlers.mouseup, options);\r\n\r\n            document.body.removeChild(this._canvas);\r\n        }\r\n\r\n        this._target = null;\r\n    }\r\n\r\n    change(rgba, hotx, hoty, w, h) {\r\n        if ((w === 0) || (h === 0)) {\r\n            this.clear();\r\n            return;\r\n        }\r\n\r\n        this._position.x = this._position.x + this._hotSpot.x - hotx;\r\n        this._position.y = this._position.y + this._hotSpot.y - hoty;\r\n        this._hotSpot.x = hotx;\r\n        this._hotSpot.y = hoty;\r\n\r\n        let ctx = this._canvas.getContext('2d');\r\n\r\n        this._canvas.width = w;\r\n        this._canvas.height = h;\r\n\r\n        let img = new ImageData(new Uint8ClampedArray(rgba), w, h);\r\n        ctx.clearRect(0, 0, w, h);\r\n        ctx.putImageData(img, 0, 0);\r\n\r\n        if (useFallback) {\r\n            this._updatePosition();\r\n        } else {\r\n            let url = this._canvas.toDataURL();\r\n            this._target.style.cursor = 'url(' + url + ')' + hotx + ' ' + hoty + ', default';\r\n        }\r\n    }\r\n\r\n    clear() {\r\n        this._target.style.cursor = 'none';\r\n        this._canvas.width = 0;\r\n        this._canvas.height = 0;\r\n        this._position.x = this._position.x + this._hotSpot.x;\r\n        this._position.y = this._position.y + this._hotSpot.y;\r\n        this._hotSpot.x = 0;\r\n        this._hotSpot.y = 0;\r\n    }\r\n\r\n    // Mouse events might be emulated, this allows\r\n    // moving the cursor in such cases\r\n    move(clientX, clientY) {\r\n        if (!useFallback) {\r\n            return;\r\n        }\r\n        // clientX/clientY are relative the _visual viewport_,\r\n        // but our position is relative the _layout viewport_,\r\n        // so try to compensate when we can\r\n        if (window.visualViewport) {\r\n            this._position.x = clientX + window.visualViewport.offsetLeft;\r\n            this._position.y = clientY + window.visualViewport.offsetTop;\r\n        } else {\r\n            this._position.x = clientX;\r\n            this._position.y = clientY;\r\n        }\r\n        this._updatePosition();\r\n        let target = document.elementFromPoint(clientX, clientY);\r\n        this._updateVisibility(target);\r\n    }\r\n\r\n    _handleMouseOver(event) {\r\n        // This event could be because we're entering the target, or\r\n        // moving around amongst its sub elements. Let the move handler\r\n        // sort things out.\r\n        this._handleMouseMove(event);\r\n    }\r\n\r\n    _handleMouseLeave(event) {\r\n        // Check if we should show the cursor on the element we are leaving to\r\n        this._updateVisibility(event.relatedTarget);\r\n    }\r\n\r\n    _handleMouseMove(event) {\r\n        this._updateVisibility(event.target);\r\n\r\n        this._position.x = event.clientX - this._hotSpot.x;\r\n        this._position.y = event.clientY - this._hotSpot.y;\r\n\r\n        this._updatePosition();\r\n    }\r\n\r\n    _handleMouseUp(event) {\r\n        // We might get this event because of a drag operation that\r\n        // moved outside of the target. Check what's under the cursor\r\n        // now and adjust visibility based on that.\r\n        let target = document.elementFromPoint(event.clientX, event.clientY);\r\n        this._updateVisibility(target);\r\n\r\n        // Captures end with a mouseup but we can't know the event order of\r\n        // mouseup vs releaseCapture.\r\n        //\r\n        // In the cases when releaseCapture comes first, the code above is\r\n        // enough.\r\n        //\r\n        // In the cases when the mouseup comes first, we need wait for the\r\n        // browser to flush all events and then check again if the cursor\r\n        // should be visible.\r\n        if (this._captureIsActive()) {\r\n            window.setTimeout(() => {\r\n                // We might have detached at this point\r\n                if (!this._target) {\r\n                    return;\r\n                }\r\n                // Refresh the target from elementFromPoint since queued events\r\n                // might have altered the DOM\r\n                target = document.elementFromPoint(event.clientX,\r\n                                                   event.clientY);\r\n                this._updateVisibility(target);\r\n            }, 0);\r\n        }\r\n    }\r\n\r\n    _showCursor() {\r\n        if (this._canvas.style.visibility === 'hidden') {\r\n            this._canvas.style.visibility = '';\r\n        }\r\n    }\r\n\r\n    _hideCursor() {\r\n        if (this._canvas.style.visibility !== 'hidden') {\r\n            this._canvas.style.visibility = 'hidden';\r\n        }\r\n    }\r\n\r\n    // Should we currently display the cursor?\r\n    // (i.e. are we over the target, or a child of the target without a\r\n    // different cursor set)\r\n    _shouldShowCursor(target) {\r\n        if (!target) {\r\n            return false;\r\n        }\r\n        // Easy case\r\n        if (target === this._target) {\r\n            return true;\r\n        }\r\n        // Other part of the DOM?\r\n        if (!this._target.contains(target)) {\r\n            return false;\r\n        }\r\n        // Has the child its own cursor?\r\n        // FIXME: How can we tell that a sub element has an\r\n        //        explicit \"cursor: none;\"?\r\n        if (window.getComputedStyle(target).cursor !== 'none') {\r\n            return false;\r\n        }\r\n        return true;\r\n    }\r\n\r\n    _updateVisibility(target) {\r\n        // When the cursor target has capture we want to show the cursor.\r\n        // So, if a capture is active - look at the captured element instead.\r\n        if (this._captureIsActive()) {\r\n            target = document.captureElement;\r\n        }\r\n        if (this._shouldShowCursor(target)) {\r\n            this._showCursor();\r\n        } else {\r\n            this._hideCursor();\r\n        }\r\n    }\r\n\r\n    _updatePosition() {\r\n        this._canvas.style.left = this._position.x + \"px\";\r\n        this._canvas.style.top = this._position.y + \"px\";\r\n    }\r\n\r\n    _captureIsActive() {\r\n        return document.captureElement &&\r\n            document.documentElement.contains(document.captureElement);\r\n    }\r\n}\r\n"]}